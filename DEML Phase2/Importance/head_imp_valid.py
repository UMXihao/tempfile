#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
@author: Xihao Sun
@contact:sunxh2016@gmail.com
@version: 1.0.0
@file: head_imp_valid.py
@time: 4/10/25 4:20 PM

最重要：读取原始模型，将layer12的head13的attn相关的权重全部置零，输入模型
最不重要：读取原始模型，将layer5的head13的attn相关的权重全部置零，输入模型
"""
import numpy as np
from transformers import LlamaForCausalLM, AutoTokenizer, AutoConfig

origin_model_path = "/home/yandong/Documents/um-data/models/Llama-2-7b-hf"
imp_dir = "/home/yandong/Documents/um-data/models/Llama-2-7b-hf-imp"
un_imp_dir = "/home/yandong/Documents/um-data/models/Llama-2-7b-hf-unimp"


def load_config(model_path):
    # 加载模型配置
    config = AutoConfig.from_pretrained(model_path)
    # print(config.head_dim)
    # print(config.num_attention_heads)
    return config


def load_model(model_path):
    model = LlamaForCausalLM.from_pretrained(model_path)  # 读取或者导出模型需要明确指定LlamaForCausalLM类型，否则自动识别为LlamaModel
    # print(model)
    return model


def save_tokenizer(model_path, directory):
    # save tokenizer
    tokenizer = AutoTokenizer.from_pretrained(model_path)
    tokenizer.save_pretrained(directory)


def save_model(model, directory):
    model.save_pretrained(directory)


def set_zero(model, layer_num, head_num, head_dim):
    layer = model.model.layers[layer_num - 1]
    start_head = head_dim * (head_num - 1)
    end_head = head_dim * head_num
    layer.self_attn.q_proj.weight.data[:, start_head:end_head] = 0
    layer.self_attn.k_proj.weight.data[:, start_head:end_head] = 0
    layer.self_attn.v_proj.weight.data[:, start_head:end_head] = 0
    layer.self_attn.o_proj.weight.data[start_head:end_head, :] = 0


def valid_test(model, layer_num, head_num, head_dim):
    """
    校验确认重置的参数生效
    """
    layer = model.model.layers[layer_num - 1]
    start_head = head_dim * (head_num - 1)
    end_head = head_dim * head_num
    print(layer.self_attn.q_proj.weight.data[:, start_head:end_head])
    print(layer.self_attn.k_proj.weight.data[:, start_head:end_head])
    print(layer.self_attn.v_proj.weight.data[:, start_head:end_head])
    print(layer.self_attn.o_proj.weight.data[start_head:end_head, :])


def find_most_imp_id(select):
    data = [[-0.34945955872535706, -0.04305020719766617, 0.07238087058067322, -0.044675253331661224, -0.026098353788256645, -0.038218118250370026, -0.06872175633907318, -0.04947372525930405, -0.05947238951921463, -0.047556180506944656, 0.0016423128545284271, 0.021102547645568848, -0.054326724261045456, -0.2735608220100403, -0.10303845256567001, -0.16848519444465637, -0.1010628268122673, 0.13465125858783722, -0.10803474485874176, -0.20204123854637146, -0.11333026736974716, -0.052446626126766205, 0.08308915793895721, -0.03174465149641037, -0.22619523108005524, -0.16553880274295807, 0.06811719387769699, -0.05837244167923927, 0.0870424285531044, -0.08251061290502548, -0.41648927330970764, -0.5012587904930115], [-0.019400065764784813, -0.2965221405029297, 0.0641777291893959, 0.11309003084897995, 0.3508714437484741, -0.07977000623941422, -0.08757968246936798, -0.022154605016112328, 0.08685130625963211, 0.08253805339336395, 0.11382244527339935, -0.43293479084968567, -0.04651915282011032, -0.1276833415031433, -0.10668325424194336, -0.08431416749954224, 0.3252764642238617, -0.5937244296073914, 0.23425012826919556, 0.0588911734521389, -0.05802253633737564, 0.04154589772224426, -0.06117463484406471, -0.06209028139710426, 0.4326842129230499, 0.023697061464190483, 0.5768973231315613, -0.08858972787857056, -0.05323528125882149, -0.029464397579431534, 0.11626944690942764, 0.14930075407028198], [0.06337320059537888, -0.015022379346191883, 0.37077468633651733, 0.16875381767749786, 0.14313830435276031, -0.024411756545305252, -0.022565163671970367, -0.001703703892417252, 0.2792205214500427, 0.02765117958188057, 0.16096781194210052, 0.6113921999931335, 0.0643666461110115, -0.0030628549866378307, 0.028164250776171684, -0.04821289703249931, 0.24911576509475708, 0.2799204885959625, 0.08182992786169052, 0.130470409989357, 0.060685813426971436, 0.16833603382110596, 0.058841001242399216, 0.028605274856090546, 0.22950142621994019, 0.11205402761697769, 0.6195127964019775, -0.009989455342292786, -0.023170335218310356, 0.03916977718472481, 0.1809331476688385, 0.31902211904525757], [0.07256552577018738, 0.021529460325837135, 0.34988167881965637, 0.15950517356395721, 0.015855226665735245, 0.027074510231614113, 0.0034342717844992876, 0.011563391424715519, 0.23295864462852478, 0.028919562697410583, 0.12705986201763153, 0.5936754941940308, 0.05142016336321831, 0.015139260329306126, 0.05444927513599396, -0.006878829561173916, 0.26263704895973206, 0.4006151854991913, 0.14594517648220062, 0.008139654994010925, 0.09238530695438385, 0.27182304859161377, 0.06104461848735809, 0.027000470086932182, 0.2937871813774109, 0.16200262308120728, 0.617554247379303, 0.01624896004796028, 0.03636865317821503, 0.027750488370656967, 0.0590408630669117, 0.1906193494796753], [0.03083704598248005, 0.007686342112720013, 0.23796574771404266, 0.10449141263961792, -0.033696211874485016, 0.014879653230309486, 0.0068160719238221645, 0.03835098445415497, 0.2683965563774109, 0.03739076480269432, 0.11111240833997726, 0.6723254919052124, 0.06670934706926346, 0.02356855198740959, 0.036594491451978683, 0.020689882338047028, 0.1060301810503006, 0.350123792886734, 0.16536401212215424, -0.0024388208985328674, 0.08512387424707413, 0.19560275971889496, 0.0707070603966713, 0.07255095988512039, 0.14129295945167542, 0.1048813909292221, 0.5162668824195862, 0.01784077286720276, 0.03165394440293312, 0.03573709726333618, 0.01746540516614914, 0.12142373621463776], [0.11948134005069733, 0.014194436371326447, 0.21147461235523224, 0.15079183876514435, 0.013124082237482071, 0.035155702382326126, 0.05548867583274841, 0.029118051752448082, 0.2780825197696686, 0.06839480996131897, 0.10609693825244904, 0.41731542348861694, 0.04428822919726372, 0.0500100776553154, 0.05036463961005211, 0.042191553860902786, 0.16447655856609344, 0.24581924080848694, 0.15020324289798737, 0.04419812187552452, 0.11225724965333939, 0.13744674623012543, 0.07573434710502625, 0.05342233180999756, 0.07852733880281448, 0.15264981985092163, 0.39732563495635986, 0.029518524184823036, -0.0005243802443146706, 0.039227358996868134, 0.021022124215960503, 0.17713072896003723], [0.02907228283584118, 0.004112081602215767, 0.12050598859786987, 0.07586648315191269, 0.009143730625510216, 0.017646504566073418, 0.03291445970535278, 0.014655528590083122, 0.2643771469593048, 0.050310168415308, 0.049122512340545654, 0.379459410905838, 0.003920714370906353, 0.04992786794900894, 0.04833003133535385, 0.0272543765604496, 0.09919121861457825, 0.1806294471025467, 0.2162415087223053, 0.04962250217795372, 0.05227116122841835, 0.13106980919837952, 0.04699346423149109, 0.04973135143518448, 0.11730903387069702, 0.07168133556842804, 0.35583338141441345, 0.01697203889489174, 0.02260996401309967, 0.015754153952002525, 0.0226286631077528, 0.0743325799703598], [0.06613881140947342, -0.03407078981399536, 0.14730121195316315, 0.035250384360551834, -0.020509621128439903, -0.005092974752187729, 0.0237240232527256, -0.01737634837627411, 0.17273002862930298, 0.0018727009883150458, 0.06761208176612854, 0.43773308396339417, 0.0037406105548143387, -0.0017681482713669538, 0.013150680810213089, -0.012198303826153278, 0.09317324310541153, 0.170261412858963, 0.17037750780582428, 0.045817337930202484, 0.021166890859603882, 0.1356763243675232, 0.011460410431027412, -0.015165876597166061, 0.058792129158973694, 0.04242769256234169, 0.3103632628917694, 0.020112015306949615, -0.011385900899767876, 0.02692198008298874, 0.016681747511029243, 0.05379880964756012], [0.039980895817279816, -0.009402437135577202, 0.13799196481704712, 0.044165946543216705, 0.0217391736805439, -0.001130713615566492, 0.005756398197263479, -0.012651168741285801, 0.21104198694229126, 0.013878087513148785, 0.03739653155207634, 0.2952086925506592, 0.0003781048581004143, -0.011554786935448647, -0.010867775417864323, -0.01802939549088478, 0.0609624944627285, 0.15344218909740448, 0.14290565252304077, 0.03581903502345085, 0.003911993466317654, 0.1338927149772644, -0.026550013571977615, 0.01972619630396366, 0.03251827880740166, 0.05132172256708145, 0.30369308590888977, 0.004881344735622406, -0.00028855307027697563, -0.019343998283147812, -0.02627706527709961, 0.048286162316799164], [0.0551077239215374, -0.0037978473119437695, 0.10841261595487595, 0.03103601559996605, -0.0013702262658625841, 0.0004172325134277344, 0.029406515881419182, -0.0022608907893300056, 0.12384616583585739, 0.009130578488111496, 0.021219216287136078, 0.2982683479785919, 0.01828080788254738, 0.010464055463671684, 0.006752511486411095, -0.0004741309676319361, 0.08921598643064499, 0.13214710354804993, 0.1101708859205246, 0.028880968689918518, 0.05956506356596947, 0.09748633205890656, -0.016009178012609482, -0.006962244398891926, 0.006396837532520294, 0.05525912344455719, 0.14033588767051697, 0.014743316918611526, -0.011889252811670303, 0.014809494838118553, -0.008291303180158138, 0.052537787705659866], [0.061129599809646606, 0.040736354887485504, 0.12757501006126404, 0.09637901186943054, 0.03241671621799469, 0.02367795631289482, 0.023872939869761467, 0.01745546981692314, 0.13666117191314697, 0.03434213250875473, 0.06955352425575256, 0.265735000371933, 0.04799675941467285, 0.044362928718328476, 0.0441458523273468, 0.04399938881397247, 0.06692680716514587, 0.11073038727045059, 0.17229540646076202, 0.08724949508905411, 0.05224248766899109, 0.09475894272327423, 0.027016572654247284, 0.059922344982624054, 0.03841413930058479, 0.06774400174617767, 0.2155415117740631, 0.05050795525312424, 0.05523806810379028, 0.05323360115289688, 0.040825869888067245, 0.1207050159573555], [-0.0019564959220588207, -0.006276517175137997, 0.04285414516925812, 0.0005109983030706644, -0.017378024756908417, -0.024288266897201538, 0.0032700214069336653, -0.025364380329847336, 0.20063401758670807, -0.01127089373767376, 0.039793699979782104, 0.18479973077774048, 0.00034655584022402763, -0.016308430582284927, -0.011834779754281044, -0.027096105739474297, 0.014375180006027222, 0.05566590651869774, 0.08804198354482651, 0.026303797960281372, -0.01121561136096716, 0.033416662365198135, 0.021494697779417038, 0.007947453297674656, -0.023697074502706528, 0.02213399112224579, 0.12147098034620285, 0.00019990652799606323, -0.025059185922145844, -0.0026168653275817633, -0.013989048078656197, 0.056945785880088806], [0.02066928893327713, 0.04275096580386162, 0.046109601855278015, 0.055255014449357986, 0.06520093232393265, 0.03692321479320526, 0.061520542949438095, 0.0428687259554863, 0.14598426222801208, 0.016715984791517258, 0.05694364011287689, 0.15259455144405365, 0.07251954823732376, 0.057335250079631805, 0.04982525110244751, 0.024311285465955734, 0.08140786737203598, 0.11311440169811249, 0.036978282034397125, 0.0862690657377243, 0.0546056292951107, 0.03844121843576431, 0.03194788098335266, 0.044605378061532974, 0.053289156407117844, 0.0441318154335022, 0.09073413163423538, 0.045785799622535706, 0.033312130719423294, 0.07262192666530609, 0.05042939633131027, 0.07114599645137787], [0.026663685217499733, 0.03371812030673027, 0.13589376211166382, 0.09880877286195755, 0.04745621979236603, 0.048613041639328, 0.03795427083969116, 0.07024431228637695, 0.18501928448677063, 0.00606556748971343, 0.08349022269248962, 0.22778339684009552, 0.02615823782980442, 0.04721555858850479, 0.026151057332754135, 0.027761191129684448, 0.15601801872253418, 0.07990314066410065, 0.16759876906871796, 0.09356659650802612, 0.04671655595302582, 0.04342835769057274, 0.06188751012086868, 0.08104712516069412, 0.05228278040885925, 0.07908806949853897, 0.19374540448188782, 0.04203253239393234, -0.0016259371768683195, 0.05404498428106308, 0.06608502566814423, 0.13978958129882812], [0.0041681816801428795, 0.02760462835431099, 0.016861150041222572, -0.013720615766942501, 0.03361687809228897, 0.022024326026439667, 0.01938660442829132, 0.0004058629274368286, 0.09569869190454483, 0.017657827585935593, 0.028279302641749382, 0.14167135953903198, -0.005631664767861366, 0.07326702028512955, -0.0029232269152998924, 0.00867408886551857, 0.031111396849155426, 0.04282934218645096, 0.056546177715063095, 0.03421487286686897, -0.004008804447948933, 0.0044789304956793785, 0.011403677985072136, 0.0070597645826637745, -0.027208130806684494, 0.016126537695527077, 0.06836501508951187, -0.010753223672509193, 0.0059850700199604034, 0.019546905532479286, 0.03253456577658653, 0.044264327734708786], [0.018910091370344162, 0.024867894127964973, 0.059907637536525726, 0.0718735009431839, 0.06347434222698212, 0.022957805544137955, 0.015909260138869286, 0.008929692208766937, 0.20688863098621368, 0.03194588050246239, 0.10460375249385834, 0.21635732054710388, 0.033129654824733734, -0.0013660271652042866, 0.014049483463168144, -0.0035136761143803596, 0.11110896617174149, 0.0955457016825676, 0.1037091463804245, 0.08728507906198502, 0.06193951517343521, 0.10066334158182144, 0.017539044842123985, 0.06131022796034813, 0.006141272373497486, 0.11653554439544678, 0.19388322532176971, 0.03375241905450821, 0.017572792246937752, 0.004689620807766914, 0.0356634221971035, 0.09689496457576752], [0.10292201489210129, 0.10718785971403122, 0.13147158920764923, 0.09730389714241028, 0.09997107088565826, 0.11658167093992233, 0.09494251012802124, 0.10967528820037842, 0.19033655524253845, 0.0942901000380516, 0.18125180900096893, 0.21933841705322266, 0.07195121794939041, 0.14480125904083252, 0.11895525455474854, 0.12155678868293762, 0.1342782974243164, 0.14143437147140503, 0.11816231161355972, 0.11030590534210205, 0.08812017738819122, 0.13842517137527466, 0.0982394814491272, 0.13002972304821014, 0.08867760747671127, 0.11757118999958038, 0.20467466115951538, 0.1171441525220871, 0.10074827075004578, 0.11309020966291428, 0.0855134129524231, 0.13940495252609253], [0.02205369435250759, 0.06953060626983643, 0.06473268568515778, -0.021411186084151268, 0.042419251054525375, 0.005521129816770554, 0.027740992605686188, 0.035356298089027405, 0.08110028505325317, -0.0106591721996665, 0.0571012869477272, 0.2161439061164856, 0.04508744925260544, 0.09948591142892838, 0.023902174085378647, 0.0374717153608799, 0.058735013008117676, 0.07496773451566696, 0.03491761162877083, 0.043251633644104004, 0.0026052347384393215, 0.0717756599187851, 0.023253194987773895, 0.01814691349864006, 0.014019226655364037, 0.04087190702557564, 0.13718697428703308, 0.022861182689666748, -0.003194402204826474, 0.0017349133267998695, 0.00917526613920927, 0.04901580512523651], [0.03468184545636177, 0.057557862251996994, 0.07945141196250916, 0.07226193696260452, 0.06815224140882492, 0.07725790143013, 0.043473731726408005, 0.05648509040474892, 0.15405496954917908, 0.06324370950460434, 0.0682237297296524, 0.25491926074028015, 0.06329039484262466, 0.043343015015125275, 0.058398663997650146, 0.09063916653394699, 0.05926118791103363, 0.12100081145763397, 0.06103280186653137, 0.05544428154826164, 0.059452056884765625, 0.10932167619466782, 0.09587351977825165, 0.08585131913423538, 0.034162238240242004, 0.0390738844871521, 0.2238399088382721, 0.05455542355775833, 0.05267957225441933, 0.07034416496753693, 0.06780511140823364, 0.08375252783298492], [0.059064820408821106, 0.06123186647891998, 0.11872291564941406, 0.03718826174736023, 0.04407443106174469, 0.023851530626416206, 0.08350469917058945, 0.06895020604133606, 0.08032774925231934, 0.042610883712768555, 0.06533506512641907, 0.2319287657737732, 0.07668149471282959, 0.04174339771270752, 0.07295133173465729, 0.061581991612911224, 0.12535633146762848, 0.0870627760887146, 0.10310953855514526, 0.08407135307788849, 0.05873408541083336, 0.11841021478176117, 0.09354031085968018, 0.06696508824825287, 0.06411047279834747, 0.1262316107749939, 0.20992358028888702, 0.09094734489917755, 0.03838508576154709, 0.07914267480373383, 0.03210965916514397, 0.10639255493879318], [0.11264358460903168, 0.08684464544057846, 0.14381510019302368, 0.07890668511390686, 0.09465034306049347, 0.09729372709989548, 0.12731477618217468, 0.09266890585422516, 0.15785306692123413, 0.1267494112253189, 0.14421871304512024, 0.2517467737197876, 0.1182592436671257, 0.09604819118976593, 0.0886903926730156, 0.085512176156044, 0.16566701233386993, 0.12871885299682617, 0.09000729769468307, 0.10910604149103165, 0.10396963357925415, 0.142054483294487, 0.1124754473567009, 0.09012924879789352, 0.0841495543718338, 0.13500623404979706, 0.18823367357254028, 0.0979626476764679, 0.06767364591360092, 0.0704541951417923, 0.09092993289232254, 0.16392825543880463], [0.04561144858598709, 0.02145233377814293, 0.06302712112665176, 0.057265110313892365, 0.020302295684814453, 0.04673231020569801, 0.06462664902210236, 0.08575763553380966, 0.15248160064220428, 0.04837248846888542, 0.04763103649020195, 0.18384309113025665, 0.04138415679335594, 0.05151889845728874, 0.08911725878715515, 0.059035710990428925, 0.0560944527387619, 0.11339885741472244, 0.09256808459758759, 0.11089631170034409, 0.057167742401361465, 0.16946648061275482, 0.08144938200712204, 0.02644212171435356, 0.017266761511564255, 0.08316071331501007, 0.08223103731870651, 0.12462932616472244, 0.09064910560846329, 0.056677673012018204, 0.04729572311043739, 0.04244527220726013], [0.013398684561252594, 0.059899359941482544, 0.029784800484776497, 0.03505835682153702, 0.045850932598114014, 0.047896336764097214, 0.04401225969195366, 0.0504547655582428, 0.09821842610836029, 0.023753777146339417, 0.027699347585439682, 0.23569659888744354, 0.03431211784482002, 0.05148842930793762, 0.0518358051776886, 0.04286139830946922, 0.0704994797706604, 0.04757431149482727, -0.025885382667183876, 0.04678940400481224, 0.045481592416763306, 0.06443826854228973, 0.03517557680606842, 0.02969265542924404, 0.039405457675457, 0.051478393375873566, 0.09286262094974518, 0.016676031053066254, 0.015201957896351814, 0.007545117754489183, 0.04698443412780762, 0.042377643287181854], [-0.0024445364251732826, -0.004797241650521755, 0.004263477399945259, -0.0378868505358696, -0.04014910012483597, 0.0016419477760791779, -0.025221239775419235, -0.038175709545612335, 0.061230383813381195, -0.024863120168447495, -0.008651727810502052, 0.12433642894029617, -0.014313707128167152, -0.0186326764523983, 0.014878592453897, -0.025170784443616867, 0.021948305889964104, 0.031683750450611115, -0.03321591019630432, -0.004026522859930992, -0.007482143584638834, 0.05366513878107071, -0.01894761435687542, -0.010726844891905785, -0.03954239934682846, -0.011846741661429405, 0.08989755809307098, -0.014229166321456432, -0.04231666773557663, 0.013824470341205597, -0.011101225391030312, 0.027155619114637375], [0.05303904414176941, 0.03542245924472809, 0.021681511774659157, -0.004443666897714138, 0.036079902201890945, 0.03247615694999695, 0.018077539280056953, 0.03917316347360611, 0.06850054115056992, 0.01057790219783783, 0.023693716153502464, 0.1713148057460785, 0.046953070908784866, 0.008115197531878948, 0.02572954259812832, 0.0586908683180809, 0.09118829667568207, 0.08208275586366653, 0.07243364304304123, 0.061030615121126175, 0.042307112365961075, 0.04671585559844971, 0.05993405729532242, 0.03932727873325348, 0.052152734249830246, 0.08781874179840088, 0.11855879426002502, 0.014731415547430515, 0.05056701600551605, 0.0050191730260849, 0.039611537009477615, 0.04569718614220619], [-0.05741783231496811, -0.041874926537275314, 0.0020720295142382383, -0.05019671469926834, -0.008942898362874985, -0.0329606868326664, -0.0324658639729023, -0.037326741963624954, 0.018930107355117798, -0.015592550858855247, 0.004622872918844223, 0.10722838342189789, -0.017129717394709587, -0.015037937089800835, -0.011001631617546082, -0.005886895582079887, -0.026732366532087326, -0.03346991166472435, -0.03805432841181755, -0.01019154954701662, -0.0187557190656662, 0.017117008566856384, 0.01883673295378685, -0.03688373789191246, -0.035455718636512756, -0.049850936979055405, 0.025497550144791603, -0.025992006063461304, -0.050398219376802444, -0.030280550941824913, -0.029713645577430725, -0.041448380798101425], [0.09801232814788818, 0.09020517021417618, 0.10419843345880508, 0.0715802013874054, 0.057163260877132416, 0.055333591997623444, 0.0659569799900055, 0.06320507824420929, 0.06138783320784569, 0.06481747329235077, 0.10641412436962128, 0.21179567277431488, 0.08799339085817337, 0.08505634218454361, 0.08820964395999908, 0.0728616937994957, 0.054925039410591125, 0.05283890664577484, 0.06533528119325638, 0.07841253280639648, 0.09873084723949432, 0.10164009034633636, 0.10623469948768616, 0.06968130171298981, 0.09023335576057434, 0.08282629400491714, 0.08506502211093903, 0.10247527062892914, 0.07847791910171509, 0.07211585342884064, 0.07688616216182709, 0.09238754212856293], [0.001531168818473816, -0.02457398921251297, -0.01797008141875267, -0.01766955852508545, -0.024505477398633957, -0.03728017956018448, 0.018718183040618896, -0.0029978440143167973, 0.008052307181060314, -0.014767784625291824, -0.029988814145326614, 0.19481521844863892, -0.0025228189770132303, 0.010638540610671043, -0.018245575949549675, -0.03888499736785889, 0.010359680280089378, -0.050470441579818726, 0.0007549296133220196, 0.01849699392914772, -0.0392579510807991, -0.009234205819666386, -0.03564433753490448, -0.04876796901226044, -0.046075981110334396, -0.03572539612650871, 0.005107940640300512, -0.013315485790371895, -0.019054312258958817, 0.00028035230934619904, -0.018269041553139687, -0.044016122817993164], [0.015694238245487213, -0.002003249479457736, 0.007023448124527931, 0.012807521969079971, 0.004798801150172949, 0.028948675841093063, 0.014065148308873177, -0.012738548219203949, 0.028638741001486778, 0.007938859052956104, 0.02313699573278427, 0.16247737407684326, 0.039296720176935196, 0.019477758556604385, -0.00045390380546450615, 0.017822764813899994, -0.005226775072515011, -0.029199164360761642, -0.0009599467739462852, -0.01814548298716545, 0.025963356718420982, 0.020054355263710022, 0.03996402397751808, -0.013055218383669853, 0.040455274283885956, 0.012639514170587063, 0.010875046253204346, 0.025356819853186607, -0.0042926291935145855, 0.03646925836801529, 0.0010718482080847025, -0.026695920154452324], [-0.021681902930140495, 0.016829662024974823, 0.021518386900424957, 0.03135041519999504, -0.02253805845975876, -0.015222392976284027, -0.020940063521265984, 0.005364780779927969, 0.032547272741794586, -0.02276620827615261, -0.0015108226798474789, 0.20727695524692535, 0.014762332662940025, 0.03320398926734924, -0.014751767739653587, 0.033884771168231964, -0.02722111903131008, 0.012560881674289703, -0.0266974288970232, -0.044786591082811356, 0.040737006813287735, 0.046595249325037, 0.014279758557677269, -0.012242455035448074, 0.0010151523165404797, 0.006085698958486319, 0.041944414377212524, 0.038316115736961365, 0.018635084852576256, 0.020791901275515556, 0.005221275612711906, -0.007237239740788937], [-0.00040937773883342743, 0.04330744594335556, 0.042174331843853, 0.043634697794914246, 0.030029453337192535, 0.019577354192733765, 0.05453239008784294, 0.022886982187628746, 0.013153906911611557, -0.004756944254040718, 0.02843550220131874, 0.2920486330986023, 0.03866582363843918, 0.029025321826338768, 0.037017177790403366, 0.002048935741186142, -0.004557405132800341, -0.01412124652415514, -0.014688107185065746, 0.0018169623799622059, 0.03781630098819733, 0.03624439984560013, 0.010493566282093525, -0.008821925148367882, 0.021628253161907196, 0.0011610491201281548, -0.06479253619909286, 0.09473535418510437, 0.021443141624331474, 0.02986021712422371, 0.012944092974066734, 0.0010378886945545673], [-0.018314704298973083, 0.010860122740268707, -0.08223316073417664, -0.01661965623497963, 0.007680871989578009, 0.004315374419093132, 0.0038127838633954525, 0.02020716667175293, -0.19741925597190857, 0.012169990688562393, -0.037593599408864975, -0.0053485482931137085, 0.044283077120780945, 0.053092412650585175, -0.005567790940403938, -0.015227410942316055, -0.10338575392961502, -0.06283596158027649, -0.042948998510837555, -0.18392124772071838, 0.004412875510752201, -0.08615997433662415, 0.025196194648742676, 0.017929047346115112, -0.01574653945863247, -0.004522012546658516, -0.11240396648645401, 0.052816834300756454, -0.0222904235124588, 0.0493105985224247, 0.026906365528702736, 0.01238345354795456]]
    if select == 'imp':
        indices = np.argmin(data, axis=1)
    else:
        indices = np.argmax(data, axis=1)
    return indices


'''对重要性层进行掩码处理'''
# origin_model = load_model(origin_model_path)
# config = load_config(origin_model_path)
# for layer, head in enumerate(find_most_imp_id('imp')):
#     set_zero(origin_model, layer, head, config.head_dim)
# save_tokenizer(origin_model_path, imp_dir)
# save_model(origin_model, imp_dir)

'''对重要性层进行验证'''
# model = load_model(imp_dir)
# config = load_config(imp_dir)
# for layer, head in enumerate(find_most_imp_id('imp')):
#     valid_test(model, layer, head, config.head_dim)

'''对不重要性层进行掩码处理'''
# origin_model = load_model(origin_model_path)
# config = load_config(origin_model_path)
for layer, head in enumerate(find_most_imp_id('un_imp')):
    print("layer:", layer, " head:", head)
    # set_zero(origin_model, layer, head, config.head_dim)
# save_tokenizer(origin_model_path, un_imp_dir)
# save_model(origin_model, un_imp_dir)

# '''对不重要性层进行验证'''
# model = load_model(un_imp_dir)
# config = load_config(un_imp_dir)
# for layer, head in enumerate(find_most_imp_id('un_imp')):
#     valid_test(model, layer, head, config.head_dim)
