#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
@author: Xihao Sun
@contact:sunxh2016@gmail.com
@version: 1.0.0
@file: head_imp_valid.py
@time: 4/10/25 4:20 PM

最重要：读取原始模型，将layer12的head13的attn相关的权重全部置零，输入模型
最不重要：读取原始模型，将layer5的head13的attn相关的权重全部置零，输入模型
"""
import numpy as np
from transformers import LlamaForCausalLM, AutoTokenizer, AutoConfig

origin_model_path = "/home/yandong/Documents/um-data/models/Llama-2-7b-hf"
imp_dir = "/home/yandong/Documents/um-data/models/Llama-2-7b-hf-imp"
un_imp_dir = "/home/yandong/Documents/um-data/models/Llama-2-7b-hf-unimp"


def load_config(model_path):
    # 加载模型配置
    config = AutoConfig.from_pretrained(model_path)
    # print(config.head_dim)
    # print(config.num_attention_heads)
    return config


def load_model(model_path):
    model = LlamaForCausalLM.from_pretrained(model_path)  # 读取或者导出模型需要明确指定LlamaForCausalLM类型，否则自动识别为LlamaModel
    # print(model)
    return model


def save_tokenizer(model_path, directory):
    # save tokenizer
    tokenizer = AutoTokenizer.from_pretrained(model_path)
    tokenizer.save_pretrained(directory)


def save_model(model, directory):
    model.save_pretrained(directory)


def set_zero(model, layer_num, head_num, head_dim):
    layer = model.model.layers[layer_num - 1]
    start_head = head_dim * (head_num - 1)
    end_head = head_dim * head_num
    layer.self_attn.q_proj.weight.data[:, start_head:end_head] = 0
    layer.self_attn.k_proj.weight.data[:, start_head:end_head] = 0
    layer.self_attn.v_proj.weight.data[:, start_head:end_head] = 0
    layer.self_attn.o_proj.weight.data[start_head:end_head, :] = 0


def valid_test(model, layer_num, head_num, head_dim):
    """
    校验确认重置的参数生效
    """
    layer = model.model.layers[layer_num - 1]
    start_head = head_dim * (head_num - 1)
    end_head = head_dim * head_num
    print(layer.self_attn.q_proj.weight.data[:, start_head:end_head])
    print(layer.self_attn.k_proj.weight.data[:, start_head:end_head])
    print(layer.self_attn.v_proj.weight.data[:, start_head:end_head])
    print(layer.self_attn.o_proj.weight.data[start_head:end_head, :])


def find_most_imp_id(select):
    data = [
        [-0.13718269765377045, -0.044866569340229034, 0.055913954973220825, -0.06728355586528778, -0.01618359424173832,
         -0.016656171530485153, -0.061979204416275024, -0.037055373191833496, -0.4232735335826874, -0.0362086147069931,
         -0.03233020007610321, 0.1022523045539856, -0.0178228709846735, -0.2241634577512741, -0.006510214880108833,
         -0.06028458848595619, -0.02766294777393341, 0.036789294332265854, -0.3648459315299988, 0.022519171237945557,
         -0.06860610842704773, -0.1581699401140213, 0.14705434441566467, -0.06070169433951378, -0.2542944848537445,
         -0.12741537392139435, 0.18753096461296082, -0.057555004954338074, 0.05920623987913132, -0.042604539543390274,
         -0.2612330913543701, -0.07566341012716293],
        [-0.1427173912525177, -0.20262010395526886, -0.17306528985500336, -0.18091291189193726, 0.2838839292526245,
         -0.06695421040058136, -0.09747800976037979, -0.10234880447387695, -0.44979485869407654, 0.01695854961872101,
         -0.08164964616298676, -0.6813036203384399, -0.012640769593417645, -0.16523098945617676, -0.13070990145206451,
         -0.08791841566562653, 0.49809983372688293, -0.6926412582397461, -0.08376485854387283, 0.2649875283241272,
         -0.07373226433992386, 0.09811278432607651, -0.09978321939706802, -0.1288326531648636, 0.05801289528608322,
         0.09421923011541367, -0.032622240483760834, -0.09846646338701248, -0.025316305458545685, -0.01970629021525383,
         0.31829118728637695, -0.0011351192370057106],
        [0.01638086885213852, 0.012853485532104969, 0.108599454164505, 0.030147545039653778, 0.31574150919914246,
         -0.05237159505486488, -0.06705774366855621, -0.014476844109594822, 0.1233256459236145, -0.07459994405508041,
         0.010104477405548096, 0.07153301686048508, 0.08104898780584335, -0.01996082067489624, 0.00947069562971592,
         0.015774117782711983, 0.32406285405158997, -0.06709857285022736, 0.2065984159708023, 0.016431797295808792,
         -0.01667860895395279, 0.11854779720306396, -0.025598865002393723, 0.025613397359848022, -0.13530471920967102,
         0.14361262321472168, 0.3058564364910126, -0.05231626331806183, 0.06718835979700089, 0.061995211988687515,
         0.06716825813055038, 0.06118190288543701],
        [0.0706811174750328, 0.025638170540332794, 0.25127503275871277, 0.024264607578516006, 0.13158784806728363,
         0.03369809687137604, -0.02616647630929947, 0.017697155475616455, 0.08307867497205734, 0.026398051530122757,
         -0.025483407080173492, 0.4405686557292938, 0.020047545433044434, 0.007809332571923733, 0.06700783967971802,
         -0.0641997903585434, 0.2502317726612091, 0.2635650038719177, 0.06658345460891724, -0.034915465861558914,
         0.017818965017795563, 0.31838205456733704, 0.02833031862974167, 0.0781891793012619, 0.1255195289850235,
         0.24209757149219513, 0.23925435543060303, -0.016927465796470642, -0.00459771603345871, 0.005198795348405838,
         -0.003161858767271042, -0.03613777458667755],
        [0.07503180205821991, 0.046052612364292145, 0.28137341141700745, 0.09767405688762665, -0.05297362804412842,
         0.006901834160089493, -0.03884286433458328, 0.03262957185506821, 0.1227085292339325, -0.0021524778567254543,
         0.061545729637145996, 0.5575290322303772, 0.08119834214448929, 0.031887877732515335, 0.05481412261724472,
         -0.03811555728316307, 0.37552720308303833, 0.2207682728767395, 0.22035154700279236, -0.13905543088912964,
         -0.010226968675851822, 0.27518269419670105, 0.043072424829006195, 0.03752061352133751, -0.11283937096595764,
         0.15196435153484344, 0.3123200535774231, -0.08015520870685577, 0.007536967284977436, -0.03170333057641983,
         -0.08757229149341583, 0.027945667505264282],
        [0.01919597201049328, 0.0426892414689064, 0.25285136699676514, 0.045926131308078766, 0.04937782883644104,
         0.036280445754528046, 0.022470775991678238, 0.08891785889863968, 0.1734738051891327, 0.01581370085477829,
         0.06543083488941193, 0.15170828998088837, 0.03623862564563751, 0.044360123574733734, 0.06983336806297302,
         -0.02262331172823906, 0.36031797528266907, 0.09922464936971664, 0.33999377489089966, 0.0097055584192276,
         0.034008074551820755, 0.22925874590873718, 0.0179374311119318, 0.06006602942943573, 0.01594286598265171,
         0.3405722975730896, 0.14402273297309875, -0.010377096012234688, -0.039449431002140045, 0.06374695152044296,
         0.036400679498910904, -0.017749762162566185],
        [-0.03437231481075287, -0.01809593103826046, 0.1255517601966858, -0.06127133592963219, 0.02472776547074318,
         -0.015624957159161568, 0.021204309538006783, -0.0073599619790911674, 0.23182211816310883, 0.03238266333937645,
         -0.027097884565591812, -0.08483349531888962, -0.015752669423818588, -0.03455933928489685,
         -0.028885681182146072, -0.03318716213107109, 0.18108604848384857, -0.07315041124820709, 0.26389044523239136,
         0.0653066635131836, -0.05779439955949783, 0.12566934525966644, -0.025640089064836502, 0.03215589001774788,
         -0.10208821296691895, 0.06159298121929169, 0.1331760287284851, -0.028052641078829765, -0.0072556063532829285,
         -0.04066599905490875, -0.051465630531311035, -0.06895651668310165],
        [-0.018045878037810326, -0.11513197422027588, 0.3048323690891266, -0.09322530776262283, -0.029394181445240974,
         -0.06452278047800064, -0.00490420451387763, -0.005235150456428528, -0.010982571169734001, -0.12220893055200577,
         -0.1024707704782486, 0.43717220425605774, -0.08447625488042831, -0.06158467009663582, -0.09427691996097565,
         -0.024479396641254425, 0.4213133454322815, -0.0208361204713583, 0.26746588945388794, -0.002875526901334524,
         -0.07597450166940689, 0.18645547330379486, -0.04508364200592041, -0.11353246867656708, -0.07657909393310547,
         0.24999184906482697, 0.2398134469985962, -0.02528468705713749, -0.10957799851894379, -0.021555431187152863,
         -0.10205735266208649, -0.06682766228914261],
        [0.02279026247560978, -0.06273088604211807, 0.28511229157447815, -0.07084443420171738, 0.0021653962321579456,
         -0.029272718355059624, 0.03400110453367233, -0.07217614352703094, 0.22932682931423187, -0.05610837787389755,
         -0.004887906834483147, 0.2769671678543091, 0.01436480414122343, 0.021873772144317627, -0.010686565190553665,
         0.0226878859102726, 0.31923535466194153, -0.028818216174840927, 0.20742714405059814, -0.004083345644176006,
         -0.013604148291051388, 0.21592597663402557, -0.002227313816547394, 0.04237744212150574, -0.02347077801823616,
         0.17371222376823425, 0.3181045353412628, 0.026824750006198883, -0.02622028812766075, 0.010395435616374016,
         -0.04324604198336601, -0.009741730988025665],
        [-0.057805731892585754, -0.039660654962062836, 0.1830676943063736, -0.05562739819288254, 0.004634414799511433,
         0.0384819433093071, -0.014089775271713734, -0.048954371362924576, 0.07073552906513214, -0.0035572443157434464,
         -0.03940265625715256, 0.19738459587097168, -0.0035096844658255577, -0.030748387798666954, -0.05791313201189041,
         0.0004430357366800308, 0.28226056694984436, -0.03781621903181076, 0.21279099583625793, 0.027632974088191986,
         -0.019724905490875244, 0.07909282296895981, -0.03339623659849167, -0.06094169244170189, -0.1005319207906723,
         0.15553128719329834, 0.2271057367324829, -0.0359111987054348, -0.043932270258665085, 0.02512551099061966,
         -0.07669062912464142, -0.025636009871959686],
        [0.04585924372076988, -0.043312035501003265, 0.25783881545066833, -0.07664729654788971, -0.010649548843502998,
         0.008183393627405167, 0.05243683606386185, 0.06578288972377777, 0.041230708360672, 0.029686059802770615,
         0.10132630169391632, 0.1546487808227539, 0.08418913185596466, 0.008154692128300667, -0.03046579658985138,
         0.080408975481987, 0.30955010652542114, -0.016703154891729355, 0.1676059067249298, 0.03027561865746975,
         -0.05917632579803467, 0.20748548209667206, 0.05099806189537048, 0.012605022639036179, -0.012217743322253227,
         0.19730418920516968, 0.3563678562641144, -0.012714842334389687, -0.01241843681782484, 0.04751068353652954,
         0.027200868353247643, -0.04381539672613144],
        [-0.049178704619407654, -0.10325312614440918, 0.07962066680192947, -0.07472169399261475, -0.05811512842774391,
         -0.07464715838432312, -0.04321290925145149, -0.057719722390174866, 0.14803479611873627, -0.040182244032621384,
         -0.016383590176701546, -0.033262163400650024, -0.08320201933383942, -0.02571752294898033, -0.13123653829097748,
         0.023758476600050926, 0.28294041752815247, -0.07007534801959991, 0.15553578734397888, 0.021614905446767807,
         -0.0708068236708641, 0.006902522873133421, 0.0022504404187202454, -0.028891930356621742, -0.11723470687866211,
         0.1241597831249237, 0.2794743776321411, -0.052731797099113464, -0.01138547994196415, -0.007603906095027924,
         -0.09638723731040955, -0.06969834864139557],
        [-0.0321168527007103, -0.08693905919790268, 0.03368571773171425, -0.057152096182107925, -0.06965287029743195,
         -0.04300684109330177, 0.0094292052090168, -0.044321272522211075, 0.04597393050789833, -0.017904458567500114,
         -0.059768978506326675, 0.25950366258621216, -0.055721305310726166, -0.041576169431209564, 0.008732292801141739,
         -0.03760816529393196, 0.2199881374835968, -0.027970723807811737, -0.061373572796583176, 0.06119982525706291,
         -0.013886275701224804, -0.011772996746003628, -0.051159799098968506, -0.020430076867341995,
         -0.10212068259716034, 0.09397123008966446, 0.1961769163608551, -0.035498104989528656, -0.09662344306707382,
         -0.02736623026430607, -0.03453505411744118, -0.06823337078094482],
        [-0.022601846605539322, -0.012651202268898487, 0.16738292574882507, -0.009677737951278687, -0.05986809358000755,
         -0.06357017904520035, -0.00582069531083107, -0.010313186794519424, -0.0048218341544270515,
         -0.04435261711478233, -0.13195163011550903, 0.46233272552490234, -0.13905048370361328, -0.04593167081475258,
         -0.09406070411205292, -0.055289044976234436, 0.39637529850006104, 0.021057553589344025, 0.22351837158203125,
         0.09933573007583618, -0.10023946315050125, 0.23368242383003235, -0.028314916417002678, -0.03918644040822983,
         -0.08949721604585648, 0.10878809541463852, 0.4007629454135895, -0.05499649420380592, -0.09489642083644867,
         -0.05079912394285202, -0.04507606476545334, -0.029774125665426254],
        [-0.011180099099874496, -0.020878193899989128, 0.03586850315332413, -0.032932937145233154,
         -0.024712102487683296, -0.031220994889736176, 0.023153407499194145, 0.018554307520389557, 0.07656394690275192,
         0.01801876723766327, 0.02189270779490471, -0.03301788866519928, -0.06140269339084625, 0.04051961004734039,
         0.0035706793423742056, 0.0040330421179533005, 0.22199785709381104, -0.041492439806461334, 0.11193803697824478,
         0.04470677301287651, 0.0035579511895775795, 0.004559016320854425, 0.002070564776659012, 0.017523810267448425,
         -0.03205826133489609, 0.11650175601243973, 0.06425929814577103, 0.03586861491203308, 0.014850079081952572,
         0.013939430005848408, 0.05895961821079254, 0.02233896404504776],
        [0.009307466447353363, 0.05461959168314934, 0.18403927981853485, 0.060175493359565735, 0.03428538516163826,
         0.03838855028152466, 0.038688525557518005, -0.04123668372631073, -0.03122042864561081, 0.03127099573612213,
         -0.021070314571261406, -0.06488779187202454, 0.048335619270801544, 0.007686814293265343, 0.02025683969259262,
         0.11468276381492615, 0.4138551652431488, 0.10224029421806335, 0.4406397044658661, -0.005461720284074545,
         -0.027466673403978348, 0.3245879113674164, 0.09544705599546432, 0.05983666330575943, 0.00665185134857893,
         0.28422030806541443, 0.25080883502960205, 0.005655970424413681, -0.00039857998490333557, 0.0037128040567040443,
         0.0903785228729248, 0.008434860035777092],
        [0.07975474745035172, 0.06660833209753036, 0.15013259649276733, -0.009055103175342083, 0.05828940495848656,
         0.10837671160697937, 0.06224321573972702, 0.12750163674354553, 0.06435313820838928, 0.11651638895273209,
         0.09615982323884964, -0.3824940323829651, 0.09038129448890686, 0.12742522358894348, 0.07262414693832397,
         0.13522379100322723, 0.20166254043579102, 0.12087196856737137, 0.28688156604766846, 0.07876227796077728,
         0.059654735028743744, 0.06510245054960251, 0.11666762828826904, 0.10950732231140137, 0.06538774818181992,
         0.10870984196662903, 0.20040428638458252, 0.07147211581468582, 0.03724491596221924, 0.0901690423488617,
         0.06652818620204926, 0.07327177375555038],
        [-0.04257594048976898, -0.0059021334163844585, 0.041128940880298615, 0.061573322862386703, -0.06108960509300232,
         0.007455585524439812, -0.02156420797109604, -0.0018520881421864033, 0.018739067018032074, -0.03127458319067955,
         -0.0082676000893116, -0.21232104301452637, 0.035480983555316925, -0.00030736811459064484, 0.011140309274196625,
         -0.03974705561995506, 0.16873207688331604, 0.21603763103485107, 0.22341495752334595, 0.03819295018911362,
         0.011974085122346878, 0.17000454664230347, 0.009803269989788532, -0.017792807891964912, -0.0583929717540741,
         0.12283895909786224, 0.047599613666534424, 0.02376469410955906, 0.006820950657129288, -0.004875818267464638,
         -0.05213189125061035, 0.008468778803944588],
        [0.1139693632721901, 0.1639508605003357, 0.169455423951149, 0.04463408887386322, 0.06251811981201172,
         0.0725223496556282, 0.04313596710562706, 0.02684631757438183, 0.061141565442085266, 0.0128716379404068,
         0.022537488490343094, 0.1863396316766739, 0.05586952716112137, 0.011674345470964909, 0.09580610692501068,
         0.07492366433143616, 0.26708465814590454, 0.10250324010848999, 0.24647550284862518, 0.11593927443027496,
         0.07792025804519653, 0.15372861921787262, 0.0753212422132492, 0.07613334059715271, 0.040193796157836914,
         0.08279875665903091, 0.18978983163833618, 0.04506579786539078, 0.017932970076799393, 0.10425223410129547,
         0.04902331158518791, 0.10013609379529953],
        [0.09836964309215546, 0.12443828582763672, 0.1866602897644043, 0.09419374167919159, 0.08609078079462051,
         0.0946991816163063, 0.08272334933280945, 0.05179250240325928, 0.09248241037130356, 0.08573969453573227,
         0.041245199739933014, 0.11316528916358948, 0.029452932998538017, 0.09196076542139053, 0.09645231813192368,
         0.0964057669043541, 0.25173160433769226, 0.16105785965919495, 0.2333085536956787, 0.061925072222948074,
         0.11385466903448105, 0.16287176311016083, 0.07719039916992188, 0.12217041850090027, 0.005925345234572887,
         0.1725282371044159, 0.08881595730781555, 0.13713867962360382, 0.08870377391576767, 0.12060604989528656,
         0.12013515830039978, 0.08848363906145096],
        [0.061737384647130966, 0.0733756572008133, 0.033845607191324234, 0.0928659588098526, 0.08668802678585052,
         0.10303951799869537, 0.07506486773490906, 0.10480570048093796, 0.07653769850730896, 0.13160598278045654,
         0.05068724602460861, 0.1305960714817047, 0.07805097848176956, 0.1039765328168869, 0.05007132142782211,
         0.1071624606847763, 0.2697117328643799, 0.21848005056381226, 0.23976914584636688, 0.13224251568317413,
         0.10523591935634613, 0.16945254802703857, 0.09422799944877625, 0.08234931528568268, 0.1237480491399765,
         0.05531492829322815, 0.14551052451133728, 0.09058882296085358, 0.05226333811879158, 0.10341621935367584,
         0.032158177345991135, 0.1366206258535385],
        [0.0352790430188179, 0.05033393204212189, 0.07288916409015656, 0.04978618025779724, 0.1260581761598587,
         0.010495266877114773, 0.061636921018362045, 0.00010205013677477837, 0.03621194511651993, 0.037668123841285706,
         0.048335663974285126, 0.31740838289260864, 0.06147234886884689, 0.07380206882953644, 0.11128899455070496,
         -0.005518971011042595, 0.11942809075117111, 0.08378300815820694, 0.04618222638964653, 0.10758427530527115,
         0.10930852591991425, 0.2612231969833374, 0.11338184028863907, 0.06585778295993805, 0.06087348610162735,
         0.03570735454559326, 0.10068347305059433, 0.0717943012714386, 0.0630573034286499, 0.1361670345067978,
         0.0856790617108345, 0.05688105523586273],
        [0.0955483466386795, 0.03457661718130112, 0.1123524084687233, 0.0938684269785881, -0.01828199252486229,
         0.02185867354273796, 0.042434774339199066, 0.09906002134084702, 0.08907559514045715, 0.09040215611457825,
         0.007595604285597801, 0.4485810101032257, 0.05207683518528938, 0.09825365245342255, 0.12584012746810913,
         0.0940435603260994, 0.295591801404953, 0.24192214012145996, 0.18159636855125427, 0.17381806671619415,
         0.05078044533729553, 0.24683573842048645, 0.09430289268493652, 0.03517470136284828, 0.01875677891075611,
         0.12552185356616974, 0.24766796827316284, 0.05857210233807564, 0.06866563856601715, 0.09015783667564392,
         0.12264300882816315, 0.11394938826560974],
        [-0.01677820272743702, 0.028248488903045654, 0.03594319894909859, 0.023346202448010445, 0.02050159126520157,
         0.05564563348889351, -0.006914608180522919, -0.020516010001301765, -0.03594692796468735, -0.0160455871373415,
         -0.012626675888895988, 0.3720990717411041, 0.0016492046415805817, -0.031194359064102173, 0.0016694902442395687,
         -0.00788437481969595, 0.1005559116601944, 0.011425571516156197, 0.012683001346886158, 0.07453207671642303,
         -0.01323804259300232, 0.12108732759952545, 0.029301481321454048, -0.04477241635322571, -0.014991587959229946,
         0.021777499467134476, 0.08596624433994293, -0.024595582857728004, -0.016803700476884842, -0.05943990498781204,
         -0.044489238411188126, 0.018113385885953903],
        [-0.006936764810234308, 0.009207247756421566, 0.09078200161457062, 0.0015316749922931194, 0.031890351325273514,
         -0.00446468498557806, 0.058385834097862244, 0.0954953208565712, 0.04709501564502716, 0.025021998211741447,
         0.04749080538749695, 0.392970472574234, 0.02499406598508358, 0.015797335654497147, 0.10076863318681717,
         0.03607412427663803, 0.1329767405986786, 0.15261708199977875, 0.16674543917179108, 0.08766714483499527,
         0.05269159749150276, 0.1491280049085617, 0.06625944375991821, 0.06755071878433228, 0.030156752094626427,
         0.08228078484535217, 0.2305760383605957, 0.014833755791187286, 0.024694938212633133, 0.034452348947525024,
         0.07260940968990326, 0.05680370703339577],
        [-0.0031175450421869755, 0.005450071766972542, 0.029924586415290833, -0.01670672930777073,
         -0.012682239525020123, 0.0012601814232766628, 0.02564096450805664, -0.012613359838724136, 0.03297404944896698,
         -0.0067213596776127815, 0.02665596455335617, 0.38985639810562134, -0.041451096534729004, -0.059581439942121506,
         0.009067002683877945, 0.048653509467840195, -0.021408386528491974, 0.007303021848201752,
         -0.0003381427377462387, 0.005855847150087357, 0.010455602779984474, 0.03567560017108917, -0.03492206335067749,
         -0.017444301396608353, -0.03297782689332962, 0.03250321000814438, 0.034848928451538086, -0.01691528782248497,
         0.0028019025921821594, 0.003219347447156906, -0.010405275039374828, -0.03423377498984337],
        [0.07458636909723282, 0.037115488201379776, 0.16628731787204742, 0.05508831515908241, 0.018001697957515717,
         0.07495095580816269, 0.024149619042873383, 0.08652138710021973, 0.06483182311058044, 0.07756318151950836,
         0.0904579684138298, 0.4674530625343323, 0.05037233978509903, 0.10731544345617294, 0.08566446602344513,
         0.04224657267332077, 0.03531394526362419, 0.009253373369574547, 0.1616157442331314, 0.06780843436717987,
         0.08653809875249863, 0.12780334055423737, 0.13698460161685944, 0.07649318873882294, 0.007327912840992212,
         0.07021935284137726, 0.14561104774475098, 0.0188981331884861, 0.09299802780151367, 0.08348564803600311,
         0.07941192388534546, 0.15244552493095398],
        [0.02053283527493477, 0.00047393515706062317, 0.030280083417892456, 0.007525325752794743, -0.01794634759426117,
         -0.0057251243852078915, 0.016258466988801956, 0.054710883647203445, 0.02926037833094597, 0.013283147476613522,
         0.01629069074988365, 0.48009708523750305, -0.014398554340004921, 0.10096151381731033, 0.054852988570928574,
         -0.000982802826911211, 0.13758033514022827, 0.05194833129644394, 0.057058077305555344, -0.049310892820358276,
         0.029598843306303024, 0.11813750863075256, 0.10850492119789124, -0.02620183676481247, 0.04348635673522949,
         0.058488719165325165, 0.048174064606428146, 0.015134360641241074, 0.0655362531542778, 0.017126813530921936,
         -0.007892712950706482, 0.007898046635091305],
        [-0.004498996771872044, 0.02819857746362686, 0.030626945197582245, 0.026847386732697487, 0.0027272715233266354,
         0.05684632807970047, 0.03230838477611542, 0.05695671960711479, 0.03652916103601456, 0.031135274097323418,
         0.0011306575033813715, 0.4174514710903168, -0.02274242416024208, 0.00018937233835458755, 0.0529712438583374,
         0.0162292942404747, -0.02777324989438057, -0.07569891959428787, 0.035431262105703354, 0.01118529587984085,
         0.09838897734880447, 0.10349682718515396, 0.0788053646683693, 0.006155273411422968, 0.039893846958875656,
         -0.01537136547267437, 0.08115813881158829, 0.04477861523628235, 0.04157587140798569, -0.01873800903558731,
         0.0302068293094635, 0.028972741216421127],
        [-0.01655910536646843, 0.022927597165107727, -0.01973862573504448, -0.02131936512887478, -0.043626800179481506,
         -0.00497778132557869, -0.033292703330516815, 0.018063649535179138, 0.015240591019392014, 0.06545522809028625,
         -0.01780545338988304, 0.4746500253677368, -0.002251420170068741, -0.046572305262088776, -0.002072693780064583,
         -0.05905381217598915, -0.06867088377475739, -0.07530657947063446, -0.0048787640407681465, -0.04249608516693115,
         0.047929178923368454, 0.05355973541736603, 0.019401421770453453, 0.025225918740034103, -0.02140912041068077,
         -0.07026603817939758, -0.08557551354169846, -0.020396847277879715, 0.08458149433135986, 0.015416208654642105,
         0.007282486651092768, 0.00971875712275505],
        [0.0198306106030941, 0.040162280201911926, -0.07706692069768906, 0.025864213705062866, -0.014622945338487625,
         -0.020770618692040443, -0.013485945761203766, 0.05842454731464386, 0.02564752846956253, 0.045851513743400574,
         0.057239070534706116, 0.5392459630966187, 0.0017723310738801956, 0.01846233941614628, 0.008286016061902046,
         0.02199111506342888, -0.09542468935251236, -0.06920599192380905, -0.03846587985754013, -0.10760822147130966,
         0.008150638081133366, -0.09047151356935501, 0.02512384206056595, 0.020132649689912796, 0.026915792375802994,
         -0.04845583438873291, -0.13189569115638733, 0.04962674528360367, -0.02822682075202465, 0.04667122662067413,
         -0.01100569125264883, 0.08469788730144501],
        [0.012199454940855503, 0.05750703811645508, -0.17851828038692474, -0.010891245678067207, 0.03510570153594017,
         0.062140852212905884, 0.0008027404546737671, 0.01753074675798416, -0.08251619338989258, 0.052980996668338776,
         -0.007975324988365173, -0.28234267234802246, 0.04397113248705864, 0.00839194469153881, -0.010311122983694077,
         0.07839785516262054, -0.37717947363853455, -0.006779201328754425, -0.35886240005493164, -0.5785073041915894,
         0.021917086094617844, -0.12922707200050354, 0.008511943742632866, 0.014140522107481956, 0.03544646501541138,
         -0.02368917316198349, -0.12544582784175873, -0.0019718282856047153, 0.02388310804963112, 0.0367216058075428,
         0.10174651443958282, 0.044141653925180435]]
    if select == 'imp':
        indices = np.argmin(data, axis=1)
    else:
        indices = np.argmax(data, axis=1)
    return indices


'''对重要性层进行掩码处理'''
# origin_model = load_model(origin_model_path)
# config = load_config(origin_model_path)
# for layer, head in enumerate(find_most_imp_id('imp')):
#     set_zero(origin_model, layer, head, config.head_dim)
# save_tokenizer(origin_model_path, imp_dir)
# save_model(origin_model, imp_dir)

'''对重要性层进行验证'''
# model = load_model(imp_dir)
# config = load_config(imp_dir)
# for layer, head in enumerate(find_most_imp_id('imp')):
#     valid_test(model, layer, head, config.head_dim)

'''对不重要性层进行掩码处理'''
# origin_model = load_model(origin_model_path)
# config = load_config(origin_model_path)
# for layer, head in enumerate(find_most_imp_id('un_imp')):
#     set_zero(origin_model, layer, head, config.head_dim)
# save_tokenizer(origin_model_path, un_imp_dir)
# save_model(origin_model, un_imp_dir)

'''对不重要性层进行验证'''
model = load_model(un_imp_dir)
config = load_config(un_imp_dir)
for layer, head in enumerate(find_most_imp_id('un_imp')):
    valid_test(model, layer, head, config.head_dim)